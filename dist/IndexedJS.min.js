/* IndexedJS 1.2.0 by Ryan Domingue
 * Source available at http://github.com/goodguyry/IndexedJS.git */

function IndexedJS(a){"use strict";window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,a=a||{},this.opts={},this.opts.database=a.name||null,this.opts.version=a.version||null,this.opts.stores=a.stores||null,!this.opts.database||!this.opts.version,this.opts.onsuccess=a.onsuccess||!1,this.opts.onerror=a.onerror||!1,this.db=null,this.open(this.opts)}IndexedJS.prototype.open=function(a){function b(a){return a.keyPath?{keyPath:a.keyPath}:a.autoIncrement?{autoIncrement:!0}:!1}var c,d=indexedDB.open(a.database,a.version);d.onupgradeneeded=function(d){var e,f=d.target.result;d.target.result.onerror=function(a){};for(var g=0;g<a.stores.length;g++)if(f.objectStoreNames.contains(a.stores[g].name)&&f.deleteObjectStore(a.stores[g].name),c=b(a.stores[g]),!f.objectStoreNames.contains(a.stores[g].name)&&(c&&(e=f.createObjectStore(a.stores[g].name,c)),a.stores[g].indexes))for(var h in a.stores[g].indexes)e.createIndex(h,h,{unique:a.stores[g].indexes[h]})},d.onsuccess=function(b){IndexedJS.db=b.target.result,a.onsuccess&&a.onsuccess(b)},d.onerror=function(b){a.onerror&&a.onerror(b)}},IndexedJS.prototype.verifyOptions=function(a){var b=a||{};return b.mode=a.mode||"readonly",b.index=a.index||!1,b.key=a.key||!1,b.data=a.data||[],b.cursor=a.cursor||!1,b.cursor.bound=a.cursor.bound||null,b.cursor.only=a.cursor.only||!1,b.cursor.lower=a.cursor.lower||!1,b.cursor.upper=a.cursor.upper||!1,b.cursor.advance=a.cursor.advance||!1,b.onerror=a.onerror||!1,b.oncomplete=a.oncomplete||!1,b.onsuccess=a.onsuccess||!1,b},IndexedJS.prototype.count=function(a,b){var c=this.verifyOptions(a);if(!b)return!1;if(IndexedJS.db){var d,e,f=IndexedJS.db.transaction(b,"readonly"),g=f.objectStore(b);e=g.count(),e.onsuccess=function(a){d=a.target.result,c.onsuccess&&c.onsuccess.call(d)},f.oncomplete=function(){c.oncomplete&&c.oncomplete(d)},e.onerror=function(a){opts.onerror&&opts.onerror(a)}}},IndexedJS.prototype.query=function(a,b){var c=this.verifyOptions(a);if(!b)return!1;if(!(c.key||c.index||c.cursor))return!1;if(IndexedJS.db){var d,e=IndexedJS.db.transaction(b,c.mode),f=e.objectStore(b);if(c.cursor){var g,h=null;"object"==typeof c.cursor.include?0===c.cursor.include.length?(c.cursor.include[0]=!1,c.cursor.include[1]=!1):1===c.cursor.include.length&&(c.cursor.include[1]=!1):c.cursor.include=c.cursor.include||!1,c.cursor.bound===!1?g=f.openCursor():c.cursor.only?(h=IDBKeyRange.only(c.cursor.only),g=f.openCursor(h)):c.cursor.lower&&c.cursor.upper?(h=IDBKeyRange.bound(c.cursor.lower,c.cursor.upper,!c.cursor.include[0],!c.cursor.include[1]),g=f.openCursor(h)):c.cursor.lower?(h=IDBKeyRange.lowerBound(c.cursor.lower,!c.cursor.include),g=f.openCursor(h)):c.cursor.upper?(h=IDBKeyRange.upperBound(c.cursor.upper,!c.cursor.include),g=f.openCursor(h)):g=f.openCursor(),g.onsuccess=function(a){d=a.target.result,d&&(c.onsuccess&&c.onsuccess.call(d),c.cursor.advance?d.advance(c.cursor.advance):d["continue"]())},e.oncomplete=function(){c.oncomplete&&(c.data?c.oncomplete(c.data):c.oncomplete())},g.onerror=function(a){opts.onerror&&opts.onerror(a)}}else if(c.key||c.index){var i;if(c.key)i=f.get(c.key);else if(c.index){var j=Object.keys(c.index)[0],k=c.index[j];i=f.index(j).get(k)}i.onsuccess=function(a){d=a.target.result,c.onsuccess&&c.onsuccess.call(d)},e.oncomplete=function(){c.oncomplete&&c.oncomplete()},i.onerror=function(a){opts.onerror&&opts.onerror(a)}}}},IndexedJS.prototype.add=function(a,b){var c=this.verifyOptions(a);if(!b)return!1;if(!c.data)return!1;if(IndexedJS.db){var d=IndexedJS.db.transaction(b,"readwrite"),e=d.objectStore(b),f=e.add(c.data);f.onsuccess=function(a){result=a.target.result,c.onsuccess&&c.onsuccess.call(result)},f.onerror=function(a){c.onerror&&c.onerror(a)},d.oncomplete=function(){c.oncomplete&&c.oncomplete()}}},IndexedJS.prototype.update=function(a,b){var c=this.verifyOptions(a);if(!b)return!1;if(!c.data)return!1;if(IndexedJS.db){var d=IndexedJS.db.transaction(b,"readwrite"),e=d.objectStore(b),f=e.put(c.data);f.onsuccess=function(a){result=a.target.result,c.onsuccess&&c.onsuccess.call(result)},f.onerror=function(a){c.onerror&&c.onerror(a)},d.oncomplete=function(){c.oncomplete&&c.oncomplete()}}},IndexedJS.prototype["delete"]=function(a,b){var c=this.verifyOptions(a);if(!b)return!1;if(!c.key)return!1;if(IndexedJS.db){var d=IndexedJS.db.transaction(b,"readwrite"),e=d.objectStore(b),f=e["delete"](c.key);f.onerror=function(a){c.onerror&&c.onerror(a)},d.oncomplete=function(){c.oncomplete&&c.oncomplete()}}};