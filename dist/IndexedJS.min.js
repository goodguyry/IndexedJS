/* IndexedJS 0.1.0 by Ryan Domingue
 * Source available at http://github.com/goodguyry/IndexedJS.git */

function IndexedJS(options){"use strict";window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,options=options||{},this.database=options.name||null,this.version=options.version||null,this.store=options.store||null,!this.database||!this.version,this.keyPath=options.keyPath||!1,this.autoIncrement=options.autoIncrement||!1,this.indexes=options.indexes||null,this.onsuccess=options.onsuccess||!1,this.onerror=options.onerror||!1,this.db=null;var that=this;this.open=function(){var setKey;setKey=that.keyPath?{keyPath:that.keyPath}:that.autoIncrement?{autoIncrement:!0}:!1;var request=indexedDB.open(that.database,that.version);request.onupgradeneeded=function(e){var objStore,db=e.target.result;if(!db.objectStoreNames.contains(that.store)&&(setKey&&(objStore=db.createObjectStore(that.store,setKey)),that.indexes))for(var key in that.indexes)objStore.createIndex(key,key,{unique:that.indexes[key]})},request.onsuccess=function(e){IndexedJS.db=e.target.result,that.onsuccess&&that.onsuccess(e)},request.onerror=function(e){that.onerror&&that.onerror(e)}}}IndexedJS.prototype.verifyOptions=function(options){var opts=options||{};return opts.mode=options.mode||"readonly",opts.index=options.index||!1,opts.key=options.key||!1,opts.data=options.data||[],opts.cursor=options.cursor||!1,opts.cursor.bound=options.cursor.bound||null,opts.cursor.only=options.cursor.only||!1,opts.cursor.lower=options.cursor.lower||!1,opts.cursor.upper=options.cursor.upper||!1,opts.onerror=options.onerror||!1,opts.oncomplete=options.oncomplete||!1,opts.onsuccess=options.onsuccess||!1,opts},IndexedJS.prototype.query=function(queryOptions,storeArray){var options=this.verifyOptions(queryOptions);if(storeArray||(storeArray=this.store),!(options.key||options.index||options.cursor))return!1;if(IndexedJS.db){var result,transaction=IndexedJS.db.transaction(storeArray,options.mode),objStore=transaction.objectStore(storeArray);if(options.cursor){var cursor,keyRange=null;"object"==typeof options.cursor.include?0===options.cursor.include.length?(options.cursor.include[0]=!1,options.cursor.include[1]=!1):1===options.cursor.include.length&&(options.cursor.include[1]=!1):options.cursor.include=options.cursor.include||!1,options.cursor.bound===!1?cursor=objStore.openCursor():options.cursor.only?(keyRange=IDBKeyRange.only(options.cursor.only),cursor=objStore.openCursor(keyRange)):options.cursor.lower&&options.cursor.upper?(keyRange=IDBKeyRange.bound(options.cursor.lower,options.cursor.upper,!options.cursor.include[0],!options.cursor.include[1]),cursor=objStore.openCursor(keyRange)):options.cursor.lower?(keyRange=IDBKeyRange.lowerBound(options.cursor.lower,!options.cursor.include),cursor=objStore.openCursor(keyRange)):options.cursor.upper?(keyRange=IDBKeyRange.upperBound(options.cursor.upper,!options.cursor.include),cursor=objStore.openCursor(keyRange)):cursor=objStore.openCursor(),cursor.onsuccess=function(e){result=e.target.result,result&&(options.onsuccess&&options.onsuccess.call(result.value),result.continue())},transaction.oncomplete=function(){options.oncomplete&&(options.data?options.oncomplete(options.data):options.oncomplete())}}else if(options.key||options.index){var request;if(options.key)request=objStore.get(options.key);else if(options.index){var indexName=Object.keys(options.index)[0],indexValue=options.index[indexName];request=objStore.index(indexName).get(indexValue)}request.onsuccess=function(e){result=e.target.result,options.onsuccess&&options.onsuccess.call(result)},transaction.oncomplete=function(){options.oncomplete&&options.oncomplete()}}}},IndexedJS.prototype.add=function(addOptions,storeArray){var options=this.verifyOptions(addOptions);if(storeArray||(storeArray=this.store),!options.data)return!1;if(IndexedJS.db){var transaction=IndexedJS.db.transaction(storeArray,"readwrite"),objStore=transaction.objectStore(storeArray),request=objStore.put(options.data);request.onsuccess=function(e){result=e.target.result,options.onsuccess&&options.onsuccess.call(result)},request.onerror=function(e){options.onerror&&options.onerror(e)},transaction.oncomplete=function(){options.oncomplete&&options.oncomplete()}}},IndexedJS.prototype.delete=function(deleteOptions,storeArray){var options=this.verifyOptions(deleteOptions);if(storeArray||(storeArray=this.store),!options.key)return!1;if(IndexedJS.db){var transaction=IndexedJS.db.transaction(storeArray,"readwrite"),objStore=transaction.objectStore(storeArray),request=objStore.delete(options.key);request.onerror=function(e){options.onerror&&options.onerror(e)},transaction.oncomplete=function(){options.oncomplete&&options.oncomplete()}}};