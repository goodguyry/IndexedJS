/* IndexedJS 1.0.0 by Ryan Domingue
 * Source available at http://github.com/goodguyry/IndexedJS.git */

function IndexedJS(options){"use strict";window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,options=options||{},this.opts={},this.opts.database=options.name||null,this.opts.version=options.version||null,this.opts.store=options.store||null,this.opts.multiStore=!1,this.opts.stores=options.stores||null,!this.opts.database||!this.opts.version,this.opts.stores&&(this.opts.multiStore=!0,this.opts.store=options.stores[0].name||null),this.opts.keyPath=options.keyPath||options.stores[0].keyPath||!1,this.opts.autoIncrement=options.autoIncrement||options.stores[0].autoIncrement||!1,this.opts.indexes=options.indexes||options.stores[0].indexes||null,this.opts.onsuccess=options.onsuccess||!1,this.opts.onerror=options.onerror||!1,this.db=null,this.open(this.opts)}IndexedJS.prototype.open=function(opts){function setKeyOption(options){return options.keyPath?{keyPath:options.keyPath}:options.autoIncrement?{autoIncrement:!0}:!1}function createAdditionalObjectStores(database,opts){var setKey,db,objStore,version=parseInt(database.version);database.close();var nextRequest=indexedDB.open(database.name,version+1);nextRequest.onupgradeneeded=function(e){setKey=setKeyOption(opts),db=e.target.result,objStore=db.createObjectStore(opts.name,setKey)},nextRequest.onsuccess=function(e){e.target.result.close()}}var setKey;setKey=setKeyOption(opts);var request=indexedDB.open(opts.database,opts.version);request.onupgradeneeded=function(e){var objStore,db=e.target.result;if(e.target.result.onerror=function(e){},db.objectStoreNames.contains(opts.store)&&db.deleteObjectStore(opts.store),!db.objectStoreNames.contains(opts.store)&&(setKey&&(objStore=db.createObjectStore(opts.store,setKey)),opts.indexes))for(var key in opts.indexes)objStore.createIndex(key,key,{unique:opts.indexes[key]})},request.onsuccess=function(e){if(IndexedJS.db=e.target.result,opts.multiStore)for(var i=1;i<opts.stores.length;i++)createAdditionalObjectStores(IndexedJS.db,opts.stores[i]);opts.onsuccess&&opts.onsuccess(e)},request.onerror=function(e){opts.onerror&&opts.onerror(e)}},IndexedJS.prototype.verifyOptions=function(options){var opts=options||{};return opts.mode=options.mode||"readonly",opts.index=options.index||!1,opts.key=options.key||!1,opts.data=options.data||[],opts.cursor=options.cursor||!1,opts.cursor.bound=options.cursor.bound||null,opts.cursor.only=options.cursor.only||!1,opts.cursor.lower=options.cursor.lower||!1,opts.cursor.upper=options.cursor.upper||!1,opts.cursor.advance=options.cursor.advance||!1,opts.onerror=options.onerror||!1,opts.oncomplete=options.oncomplete||!1,opts.onsuccess=options.onsuccess||!1,opts},IndexedJS.prototype.query=function(queryOptions,storeArray){var options=this.verifyOptions(queryOptions);if(storeArray||(storeArray=this.opts.store),!(options.key||options.index||options.cursor))return!1;if(IndexedJS.db){var result,transaction=IndexedJS.db.transaction(storeArray,options.mode),objStore=transaction.objectStore(storeArray);if(options.cursor){var cursor,keyRange=null;"object"==typeof options.cursor.include?0===options.cursor.include.length?(options.cursor.include[0]=!1,options.cursor.include[1]=!1):1===options.cursor.include.length&&(options.cursor.include[1]=!1):options.cursor.include=options.cursor.include||!1,options.cursor.bound===!1?cursor=objStore.openCursor():options.cursor.only?(keyRange=IDBKeyRange.only(options.cursor.only),cursor=objStore.openCursor(keyRange)):options.cursor.lower&&options.cursor.upper?(keyRange=IDBKeyRange.bound(options.cursor.lower,options.cursor.upper,!options.cursor.include[0],!options.cursor.include[1]),cursor=objStore.openCursor(keyRange)):options.cursor.lower?(keyRange=IDBKeyRange.lowerBound(options.cursor.lower,!options.cursor.include),cursor=objStore.openCursor(keyRange)):options.cursor.upper?(keyRange=IDBKeyRange.upperBound(options.cursor.upper,!options.cursor.include),cursor=objStore.openCursor(keyRange)):cursor=objStore.openCursor(),cursor.onsuccess=function(e){result=e.target.result,result&&(options.onsuccess&&options.onsuccess.call(result),options.cursor.advance?result.advance(options.cursor.advance):result["continue"]())},transaction.oncomplete=function(){options.oncomplete&&(options.data?options.oncomplete(options.data):options.oncomplete())}}else if(options.key||options.index){var request;if(options.key)request=objStore.get(options.key);else if(options.index){var indexName=Object.keys(options.index)[0],indexValue=options.index[indexName];request=objStore.index(indexName).get(indexValue)}request.onsuccess=function(e){result=e.target.result,options.onsuccess&&options.onsuccess.call(result)},transaction.oncomplete=function(){options.oncomplete&&options.oncomplete()}}}},IndexedJS.prototype.add=function(addOptions,storeArray){var options=this.verifyOptions(addOptions);if(storeArray||(storeArray=this.opts.store),!options.data)return!1;if(IndexedJS.db){var transaction=IndexedJS.db.transaction(storeArray,"readwrite"),objStore=transaction.objectStore(storeArray),request=objStore.put(options.data);request.onsuccess=function(e){result=e.target.result,options.onsuccess&&options.onsuccess.call(result)},request.onerror=function(e){options.onerror&&options.onerror(e)},transaction.oncomplete=function(){options.oncomplete&&options.oncomplete()}}},IndexedJS.prototype["delete"]=function(deleteOptions,storeArray){var options=this.verifyOptions(deleteOptions);if(storeArray||(storeArray=this.opts.store),!options.key)return!1;if(IndexedJS.db){var transaction=IndexedJS.db.transaction(storeArray,"readwrite"),objStore=transaction.objectStore(storeArray),request=objStore["delete"](options.key);request.onerror=function(e){options.onerror&&options.onerror(e)},transaction.oncomplete=function(){options.oncomplete&&options.oncomplete()}}};